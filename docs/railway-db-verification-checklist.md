# Railway Database Verification Checklist - r1x-db

Use this checklist to ensure your r1x-db PostgreSQL database is correctly configured and operational on Railway.

## Pre-Deployment Checklist

### 1. Database Service Setup
- [ ] PostgreSQL database service created on Railway
- [ ] Database service shows green/active status
- [ ] Database service has a unique name (e.g., `r1x-db`)

### 2. Environment Variables
- [ ] `DATABASE_URL` exists in PostgreSQL service variables (auto-generated by Railway)
- [ ] `DATABASE_URL` is accessible in Next.js service variables
- [ ] Connection string format: `postgresql://user:password@host:port/database`

### 3. Application Configuration
- [ ] `railway.json` uses `sh scripts/start.sh` as start command
- [ ] `scripts/start.sh` exists and is executable
- [ ] `Dockerfile` copies `scripts/` directory
- [ ] `nixpacks.toml` (if used) references start script

### 4. Code Configuration
- [ ] `prisma/schema.prisma` defines all required models
- [ ] Migration file exists: `prisma/migrations/20250103000000_init/migration.sql`
- [ ] `src/lib/db.ts` exports Prisma client correctly
- [ ] Health check endpoint exists: `src/app/api/health/db/route.ts`

## Post-Deployment Verification

### 1. Check Deployment Logs
- [ ] Deployment completed successfully
- [ ] Logs show: "Running database migrations..."
- [ ] Logs show: "✓ Database migrations completed successfully" OR "Migration failed or already applied"
- [ ] Logs show: "✓ Database connection verified"
- [ ] No database connection errors in logs

### 2. Test Health Check Endpoint
```bash
curl https://your-app.up.railway.app/api/health/db
```

Expected response:
```json
{
  "status": "healthy",
  "database": {
    "connected": true,
    "tables": {
      "found": 4,
      "expected": 4,
      "missing": [],
      "allPresent": true
    },
    "data": {
      "services": 0,
      "transactions": 0,
      "fees": 0
    },
    "migrations": {
      "recent": 1,
      "pending": 0,
      "lastMigration": "20250103000000_init"
    }
  }
}
```

Checklist:
- [ ] Status is `"healthy"`
- [ ] `connected` is `true`
- [ ] All expected tables present (`Service`, `Transaction`, `Fee`, `_prisma_migrations`)
- [ ] No pending migrations
- [ ] Last migration matches expected: `20250103000000_init`

### 3. Verify Database Tables

Via Railway CLI or Prisma Studio:
```bash
railway run npx prisma studio
```

Check:
- [ ] `Service` table exists
- [ ] `Transaction` table exists
- [ ] `Fee` table exists
- [ ] `_prisma_migrations` table exists

### 4. Test Database Operations

#### Test Service Creation (via API)
```bash
curl -X POST https://your-app.up.railway.app/api/sync/payai
```

Check:
- [ ] Request succeeds (200 or 500 with error message)
- [ ] If 500, verify it's a PayAI connection issue, not database issue
- [ ] Check logs for database errors

#### Test Service Reading (via API)
```bash
curl https://your-app.up.railway.app/api/marketplace/services
```

Check:
- [ ] Request succeeds
- [ ] Returns JSON array (empty or with services)
- [ ] No database connection errors

### 5. Monitor Database Usage

In Railway Dashboard:
- [ ] Check database service metrics
- [ ] Verify connection count is reasonable
- [ ] Check for any error indicators
- [ ] Monitor database size growth

## Troubleshooting

### If Health Check Fails

**Status: "unhealthy"**
1. Check `DATABASE_URL` in Next.js service variables
2. Verify PostgreSQL service is running
3. Check deployment logs for connection errors
4. Verify network connectivity between services

**Missing Tables**
1. Run migrations manually: `railway run npx prisma migrate deploy`
2. Check migration logs for errors
3. Verify Prisma schema matches expected tables

**Pending Migrations**
1. Check migration status: `railway run npx prisma migrate status`
2. Apply pending migrations: `railway run npx prisma migrate deploy`
3. Verify migration files exist in `prisma/migrations/`

### If Migrations Don't Run

1. **Check start script:**
   ```bash
   railway run cat scripts/start.sh
   ```

2. **Verify script is executable:**
   - Check Dockerfile includes: `RUN chmod +x scripts/start.sh`
   - Verify script is copied: `COPY --from=builder /app/scripts ./scripts`

3. **Check railway.json:**
   - Should have: `"startCommand": "sh scripts/start.sh"`

4. **Manual migration:**
   ```bash
   railway run npx prisma migrate deploy
   ```

### If Database Connection Fails

1. **Verify DATABASE_URL format:**
   ```
   postgresql://user:password@host:port/database
   ```

2. **Check PostgreSQL service status:**
   - Must be green/active
   - Check service logs for errors

3. **Verify network connectivity:**
   - Railway services in same project auto-connect
   - Check if services are in same project

4. **Test connection manually:**
   ```bash
   railway run npx prisma db execute --stdin <<< "SELECT 1;"
   ```

## Expected Database Schema

### Tables

1. **Service**
   - Columns: id, serviceId, name, description, category, merchant, network, chainId, token, tokenSymbol, price, priceDisplay, endpoint, available, metadata, createdAt, updatedAt
   - Indexes: merchant, network+chainId, category, available

2. **Transaction**
   - Columns: id, serviceId, transactionHash, blockNumber, from, to, amount, token, chainId, quoteNonce, quoteDeadline, feeAmount, merchantAmount, status, verificationStatus, settlementHash, timestamp, verifiedAt, settledAt
   - Indexes: transactionHash, from, to, status, serviceId, timestamp

3. **Fee**
   - Columns: id, transactionId, feeAmount, feeRecipient, transferHash, transferred, transferredAt, createdAt
   - Indexes: transactionId, feeRecipient, transferred

4. **\_prisma_migrations**
   - Managed by Prisma
   - Tracks applied migrations

## Maintenance

### Regular Checks
- [ ] Monitor database size (Railway dashboard)
- [ ] Check connection pool usage
- [ ] Review slow queries (if available)
- [ ] Verify migrations run on each deployment

### Before Schema Changes
1. Create migration locally: `npx prisma migrate dev --name description`
2. Test migration locally
3. Commit migration files
4. Deploy - migrations run automatically via start script

### Backup (if needed)
Railway provides automatic backups for PostgreSQL. Check Railway dashboard for backup options.

## Success Criteria

✅ All checklist items completed
✅ Health check returns `"status": "healthy"`
✅ All tables exist and are accessible
✅ API endpoints can read/write to database
✅ No errors in deployment logs
✅ Migrations run automatically on deployment

## Next Steps

After database verification:
1. Configure other environment variables (see `docs/railway-env-vars.md`)
2. Sync PayAI services: `POST /api/sync/payai`
3. Test full application workflow
4. Monitor logs for any issues

## Support Resources

- Railway Database Docs: https://docs.railway.app/databases/postgresql
- Prisma Migration Docs: https://www.prisma.io/docs/guides/migrate
- Railway Support: https://railway.app/help

